/*
 * Copyright 2012 Google Inc.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Resolve frequency signal (1.0 in Q24 format = 1 octave) to phase delta.

// The LUT is just a global, and we'll need the init function to be called before
// use.

#include <stdint.h>
#include <math.h>
#include "freqlut.h"

#define LG_N_SAMPLES 10
#define N_SAMPLES (1 << LG_N_SAMPLES)
#define SAMPLE_SHIFT (24 - LG_N_SAMPLES)

#define MAX_LOGFREQ_INT 20

#if 1 //eh2k

#ifndef FLASHMEM
#include "pgmspace.h"
#endif

const int32_t lut[N_SAMPLES + 1] FLASHMEM = {
  366503872,366752043,367000382,367248889,367497565,367746409,367995421,368244602,368493952,368743470,368993158,369243014,369493040,369743235,369993600,370244134,370494838,370745711,370996754,371247968,371499351,371750905,
  372002628,372254523,372506588,372758823,373011230,373263807,373516556,373769475,374022566,374275828,374529262,374782867,375036644,375290593,375544714,375799006,376053472,376308109,376562919,376817901,377073056,377328384,
  377583884,377839558,378095405,378351425,378607618,378863985,379120525,379377239,379634127,379891189,380148425,380405835,380663420,380921179,381179112,381437220,381695503,381953961,382212594,382471402,382730385,382989543,
  383248877,383508387,383768072,384027933,384287970,384548183,384808573,385069139,385329881,385590799,385851895,386113167,386374616,386636242,386898045,387160026,387422184,387684519,387947032,388209723,388472592,388735639,
  388998863,389262267,389525848,389789608,390053546,390317664,390581960,390846435,391111089,391375922,391640935,391906127,392171499,392437050,392702781,392968692,393234783,393501055,393767506,394034138,394300951,394567944,
  394835118,395102473,395370009,395637727,395905625,396173705,396441966,396710409,396979034,397247841,397516829,397786000,398055353,398324889,398594607,398864507,399134591,399404857,399675306,399945939,400216755,400487754,
  400758936,401030302,401301852,401573586,401845504,402117606,402389892,402662363,402935018,403207857,403480882,403754091,404027485,404301065,404574829,404848779,405122915,405397236,405671743,405946436,406221314,406496379,
  406771631,407047068,407322692,407598503,407874500,408150685,408427056,408703615,408980360,409257293,409534414,409811722,410089219,410366903,410644775,410922835,411201083,411479520,411758146,412036960,412315962,412595154,
  412874535,413154105,413433864,413713813,413993952,414274280,414554797,414835505,415116403,415397491,415678769,415960238,416241898,416523748,416805789,417088021,417370444,417653058,417935864,418218861,418502050,418785431,
  419069003,419352768,419636724,419920873,420205214,420489748,420774475,421059394,421344506,421629812,421915310,422201002,422486887,422772966,423059239,423345705,423632365,423919220,424206269,424493512,424780949,425068581,
  425356408,425644430,425932647,426221059,426509667,426798469,427087468,427376662,427666052,427955638,428245419,428535398,428825572,429115943,429406511,429697275,429988236,430279394,430570750,430862302,431154052,431446000,
  431738145,432030489,432323030,432615769,432908706,433201842,433495176,433788709,434082441,434376371,434670501,434964830,435259358,435554085,435849012,436144139,436439466,436734992,437030719,437326646,437622773,437919101,
  438215629,438512359,438809289,439106420,439403752,439701286,439999021,440296958,440595097,440893437,441191980,441490724,441789671,442088821,442388173,442687727,442987485,443287445,443587609,443887975,444188546,444489319,
  444790297,445091478,445392863,445694452,445996245,446298243,446600445,446902852,447205464,447508280,447811302,448114529,448417961,448721599,449025442,449329491,449633745,449938206,450242873,450547746,450852826,451158112,
  451463605,451769305,452075212,452381326,452687647,452994176,453300912,453607856,453915008,454222368,454529936,454837712,455145697,455453890,455762292,456070902,456379722,456688750,456997988,457307436,457617093,457926959,
  458237036,458547322,458857819,459168525,459479442,459790570,460101908,460413457,460725217,461037189,461349371,461661765,461974370,462287187,462600216,462913457,463226910,463540575,463854453,464168543,464482845,464797361,
  465112090,465427031,465742186,466057555,466373136,466688932,467004941,467321165,467637602,467954254,468271120,468588201,468905496,469223007,469540732,469858672,470176828,470495199,470813786,471132589,471451607,471770841,
  472090292,472409959,472729842,473049942,473370258,473690792,474011542,474332510,474653695,474975098,475296718,475618556,475940612,476262886,476585378,476908089,477231018,477554166,477877532,478201118,478524923,478848946,
  479173190,479497653,479822335,480147238,480472360,480797703,481123266,481449049,481775053,482101277,482427723,482754390,483081277,483408387,483735717,484063270,484391044,484719040,485047258,485375698,485704361,486033246,
  486362354,486691685,487021239,487351016,487681017,488011240,488341688,488672359,489003254,489334373,489665716,489997284,490329076,490661093,490993335,491325801,491658493,491991410,492324553,492657921,492991515,493325334,
  493659380,493993652,494328150,494662875,494997826,495333005,495668410,496004042,496339902,496675989,497012303,497348845,497685616,498022614,498359840,498697295,499034978,499372890,499711031,500049401,500387999,500726827,
  501065885,501405172,501744689,502084436,502424412,502764619,503105057,503445725,503786623,504127752,504469113,504810704,505152527,505494581,505836867,506179385,506522135,506865116,507208330,507551777,507895455,508239367,
  508583512,508927889,509272500,509617344,509962421,510307733,510653278,510999057,511345070,511691317,512037799,512384516,512731467,513078653,513426074,513773731,514121623,514469750,514818114,515166713,515515548,515864619,
  516213927,516563471,516913252,517263270,517613525,517964017,518314746,518665713,519016918,519368360,519720040,520071959,520424115,520776511,521129144,521482017,521835128,522188479,522542069,522895898,523249967,523604275,
  523958824,524313613,524668641,525023911,525379420,525735171,526091162,526447395,526803869,527160584,527517540,527874739,528232179,528589861,528947785,529305952,529664361,530023013,530381908,530741046,531100427,531460052,
  531819920,532180031,532540387,532900986,533261830,533622918,533984250,534345827,534707649,535069716,535432028,535794586,536157389,536520437,536883732,537247272,537611059,537975092,538339371,538703897,539068670,539433690,
  539798957,540164472,540530234,540896243,541262501,541629006,541995760,542362762,542730012,543097511,543465259,543833256,544201503,544569998,544938743,545307738,545676983,546046477,546416222,546786217,547156463,547526959,
  547897707,548268705,548639955,549011456,549383208,549755212,550127468,550499977,550872737,551245750,551619015,551992533,552366305,552740329,553114606,553489137,553863922,554238960,554614252,554989798,555365599,555741654,
  556117964,556494528,556871348,557248423,557625753,558003338,558381179,558759276,559137629,559516239,559895104,560274226,560653605,561033241,561413134,561793284,562173691,562554356,562935279,563316460,563697899,564079596,
  564461552,564843766,565226239,565608971,565991962,566375213,566758723,567142492,567526522,567910812,568295362,568680172,569065243,569450574,569836167,570222020,570608135,570994511,571381149,571768049,572155211,572542634,
  572930321,573318269,573706481,574094955,574483692,574872693,575261957,575651484,576041276,576431331,576821650,577212234,577603082,577994195,578385572,578777215,579169123,579561296,579953735,580346439,580739410,581132646,
  581526149,581919918,582313954,582708256,583102826,583497663,583892767,584288139,584683778,585079686,585475861,585872305,586269017,586665998,587063247,587460766,587858553,588256610,588654937,589053533,589452400,589851536,
  590250942,590650620,591050567,591450786,591851275,592252036,592653068,593054371,593455947,593857794,594259913,594662305,595064969,595467906,595871115,596274598,596678354,597082383,597486686,597891262,598296113,598701238,
  599106637,599512310,599918258,600324481,600730979,601137753,601544802,601952126,602359726,602767603,603175755,603584184,603992889,604401871,604811130,605220667,605630480,606040571,606450940,606861586,607272511,607683714,
  608095195,608506955,608918994,609331312,609743908,610156785,610569941,610983376,611397092,611811088,612225364,612639920,613054758,613469876,613885275,614300956,614716918,615133161,615549687,615966494,616383584,616800957,
  617218611,617636549,618054770,618473274,618892061,619311132,619730486,620150125,620570047,620990254,621410746,621831522,622252583,622673930,623095561,623517479,623939681,624362170,624784945,625208006,625631353,626054988,
  626478909,626903117,627327612,627752395,628177465,628602824,629028470,629454404,629880627,630307139,630733939,631161028,631588407,632016075,632444032,632872280,633300817,633729644,634158762,634588170,635017869,635447860,
  635878141,636308713,636739578,637170733,637602181,638033921,638465954,638898279,639330896,639763807,640197011,640630508,641064298,641498382,641932761,642367433,642802400,643237661,643673217,644109068,644545214,644981655,
  645418392,645855425,646292753,646730378,647168299,647606516,648045031,648483842,648922950,649362356,649802059,650242060,650682359,651122956,651563851,652005045,652446538,652888329,653330420,653772810,654215500,654658489,
  655101778,655545368,655989258,656433448,656877939,657322732,657767825,658213220,658658916,659104914,659551215,659997817,660444722,660891929,661339439,661787253,662235369,662683789,663132512,663581540,664030871,664480507,
  664930447,665380692,665831242,666282096,666733256,667184722,667636493,668088570,668540954,668993643,669446639,669899942,670353552,670807469,671261693,671716225,672171065,672626213,673081668,673537433,673993506,674449887,
  674906578,675363578,675820887,676278506,676736435,677194674,677653224,678112083,678571254,679030735,679490528,679950632,680411047,680871774,681332814,681794165,682255829,682717805,683180094,683642697,684105612,684568841,
  685032383,685496240,685960410,686424895,686889695,687354809,687820238,688285982,688752042,689218417,689685108,690152115,690619438,691087077,691555034,692023307,692491897,692960805,693430030,693899572,694369433,694839612,
  695310109,695780925,696252060,696723513,697195286,697667378,698139790,698612522,699085574,699558947,700032639,700506653,700980988,701455643,701930620,702405919,702881540,703357482,703833747,704310335,704787245,705264478,
  705742034,706219914,706698117,707176644,707655495,708134670,708614170,709093994,709574144,710054618,710535418,711016543,711497994,711979772,712461875,712944305,713427061,713910145,714393555,714877293,715361358,715845751,
  716330472,716815522,717300900,717786606,718272641,718759006,719245700,719732723,720220076,720707759,721195773,721684116,722172791,722661796,723151133,723640800,724130800,724621131,725111794,725602790,726094118,726585778,
  727077772,727570098,728062758,728555752,729049080,729542741,730036737,730531067,731025732,731520732,732016067,732511738,733007744,
};

void Freqlut::init(float sample_rate) {
}

#else

int32_t lut[N_SAMPLES + 1];

void Freqlut::init(float sample_rate) {
  double y = (1LL << (24 + MAX_LOGFREQ_INT)) / sample_rate;
  double inc = pow(2, 1.0 / N_SAMPLES);
  for (int i = 0; i < N_SAMPLES + 1; i++) {
    lut[i] = (int32_t)floor(y + 0.5);
    y *= inc;
  }
}

#endif

// Note: if logfreq is more than 20.0, the results will be inaccurate. However,
// that will be many times the Nyquist rate.
int32_t Freqlut::lookup(int32_t logfreq) {
  int ix = (logfreq & 0xffffff) >> SAMPLE_SHIFT;

  int32_t y0 = lut[ix];
  int32_t y1 = lut[ix + 1];
  int lowbits = logfreq & ((1 << SAMPLE_SHIFT) - 1);
  int32_t y = y0 + ((((int64_t)(y1 - y0) * (int64_t)lowbits)) >> SAMPLE_SHIFT);
  int hibits = logfreq >> 24;
  return y >> (MAX_LOGFREQ_INT - hibits);
}
